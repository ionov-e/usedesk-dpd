<html><head><style>body {
   color: black;
}
</style></head><body><h1 id="-usedesk-dpd-php-">Реализация работы динамического блока Usedesk для DPD доставки (используя PHP)</h1>
<h2 id="-">Описание</h2>
<p>Скрипт реализует возможность создания и трекинга товарно-транспортной накладной (<strong>ТТН</strong>) созданной
в <a href="https://www.dpd.ru/">ТК DPD</a> для каждого отдельного запроса/<strong>тикета</strong> в интерфейсе <a href="https://usedesk.ru">Usedesk</a>.</p>
<h2 id="-">Использование</h2>
<p>Пользователь взаимодействует с работой этого проекта в 3 местах:</p>
<ul>
<li><a href="#header_dynamic">Динамический блок на странице тикета Usedesk</a></li>
<li><a href="#header_create_ttn_page">Страница создания ТТН</a></li>
<li><a href="#header_update_cities">Обновление списка городов от DPD</a></li>
</ul>
<h4 id="-usedesk-a-id-header_dynamic-">Динамический блок на странице тикета Usedesk <a id="header_dynamic" /></h4>
<p>На странице каждого тикета на сайте Usedesk справа в динамическом блоке отображается:</p>
<ul>
<li><p><strong>Случай, если еще не создавали ТТН для этого тикета из интерфейса:</strong></p>
<p>Кнопка, ведущая на <a href="#header_create_ttn_page">страницу оформления ТТН</a> для DPD</p>
</li>
</ul>
<p><img src="http://gipernew.vertical-web.ru/dpd/docs/images/usedesk-block-0.png" alt="block0"></p>
<ul>
<li><p><strong>Если уже создана ТТН, осуществив оформление в предыдущем пункте:</strong></p>
<p>Отображение актуального статуса оформления ТТН или содержимое из прошлого пункта (если заказ был отменен DPD по
каким-либо причинам)</p>
</li>
</ul>
<p>При открытии страницы тикета - запрос успевает отсылаться сразу на DPD, и вернуть статус заказа для перепроверки на
всякий случай. Т.е. пользователь видит актуальную информацию. Выходит, что пользователь либо увидит зеленый блок с
номером ТТН, либо желтый с уведомлением о внутренней доработке
заказа DPD (может быть, если введенный адрес не был одобрен системой DPD автоматически)</p>
<p>У пользователя есть возможность отвязать ТТН от тикета в интерфейсе Usedesk, перейдя по красной кнопке внизу &quot;Отвязать
созданную ТТН&quot;. После перехода по кнопке, обновив страницу тикета пользователь увидит прошлый вариант блока с
возможностью оформления ТТН – буд-то ТТН и не создавали ранее для тикета.</p>
<p><img src="http://gipernew.vertical-web.ru/dpd/docs/images/usedesk-block-1.png" alt="block1">
<img src="http://gipernew.vertical-web.ru/dpd/docs/images/usedesk-block-2.png" alt="block2"></p>
<h4 id="-a-id-header_create_ttn_page-">Страница создания ТТН <a id="header_create_ttn_page" /></h4>
<p>От пользователя требуется заполнить все необходимые поля (помечены звездочке в начале заголовка).</p>
<p><img src="http://gipernew.vertical-web.ru/dpd/docs/images/usedesk-dpd-form.png" alt="форма"></p>
<p><strong>Особенности:</strong></p>
<ul>
<li>Некоторые поля предзаполнены - можно изменить содержимое.</li>
<li>При заполнении поля &quot;Населенный пункт&quot; ниже высветится список с подходящими к введенному запросу населенными пунктами.
Пользователю необходимо будет кликнуть на подходящий ему выбор из списка (сделано для того, чтобы пользователь с
меньшей вероятностью совершил ошибку в названии населенного пункта, его типа и названии региона)</li>
<li><p>После заполнения всех полей пользователю следует нажать на кнопку внизу &quot;Отправить&quot;. После чего он увидит ответ от DPD</p>
<ul>
<li><p>3 возможных варианта:</p>
<ul>
<li>Успешное получение ТТН с выводом номера</li>
<li>Заказ на доработке DPD (если адрес автоматически ими не одобрен)</li>
<li>Произошла ошибка с выводом этой ошибки. Например, была введена несуществующая улица</li>
</ul>
<p>Первые 2 случая заносятся в базу. И при следующем посещении страницы тикета Usedesk - в соответствующем блоке
будет отображаться актуальная информация о статусе ТТН. В последнем случае - пользователь может совершить
оформление заново: либо обновив страницу, либо заново перейдя по кнопке оформления заказа из страницы тикета
Usedesk.</p>
</li>
</ul>
</li>
</ul>
<h4 id="-dpd-a-id-header_update_cities-">Обновление списка городов от DPD <a id="header_update_cities" /></h4>
<p>Использование этой возможности имеет смысл только в том случае, если выбран <a href="#search_mode">режим поиска городов</a>
последний (использование актуального списка населенных пунктов с возможностью доставки курьером от DPD)</p>
<p>Переход по следующей ссылке произведет обновление автоматически и выведет на экран <code>Обновление успешно</code> при успешном
завершении.</p>
<p><code>http://your.domain/dpd-update-city-list.php</code> - т.е. такой же адрес как и у основного выполняющегося
файла <code>usedesk-dpd.php</code>. Отличается лишь название файла.</p>
<p>На вышеуказанный адресс можно повесить CRON-задачу, либо на свое усмотрение раз в какой-то период перейти по ссылке -
больше ничего. На сервере обновятся или создадутся (если впервые запущен) файлы, где хранится актуальный вышеупомянутый
список.</p>
<h2 id="-">Особенности использования скрипта</h2>
<h3 id="-">Установка на сервер</h3>
<ol>
<li>Выполняем <code>git clone https://github.com/ionov-e/usedesk-dpd.git .</code> в соответствующей созданной папке для проекта на
своем хостинге/сервере</li>
<li>В настройках Nginx/Apache в файле конфигурации проекта указываем папку <strong>public</strong> как root. Например, для nginx
строка вида: <code>root /var/www/your_folder/public;</code> (вместо пути &quot;/var/www/your_folder/&quot; - указываете собственный к
проекту).</li>
<li>Зайти в папку с файлами и выполнить <code>composer update</code></li>
<li>Перейти к следующему разделу - <a href="#header_env_file">создание файла <strong>.env</strong></a></li>
<li>При желании можно сделать копию файла <code>index.php.example</code> в папке <strong>public</strong> и переименовать копию
в <code>index.php</code> <a id="index_file" />. Тогда
в <a href="#usedesk_url">URL при настройках блока Usedesk</a> достаточно будет ввести
домен или путь к папке содержащую <code>index.php</code></li>
</ol>
<h3 id="-env-a-id-header_env_file-">Создание/редактирование файла окружения .env <a id="header_env_file" /></h3>
<p>В содержимом репозитория есть файл <strong>.env.example</strong> - делаем его копию (в той же папке) с названием <strong>.env</strong></p>
<p>Внутри файла <strong>.env</strong>:</p>
<ul>
<li><strong>CLIENT_NUMBER</strong> - клиентский номер в DPD (номер договора, указан вверху-справа в личном кабинете DPD)</li>
<li><strong>CLIENT_KEY</strong> - уникальный ключ авторизации, полученный у сотрудника DPD. В примере (<strong>.env.example</strong>) для первых
двух значений введены данные для доступа к тестовому аккаунту от DPD</li>
<li><strong>URL_SCRIPT_DOMAIN</strong> - URL-адрес откуда будут доступны вложенные в скрипт файлы (без &#39;/&#39; на конце)</li>
<li><strong>URL_DPD_DOMAIN</strong> - Сервер DPD. Первый - тестовый, второй - рабочий. Один закомментировать. Используется при создании
ТТН и обновлении списка их городов (последнее выполняется лишь, если в следующем параметре <strong>CITY_LIST_SEARCH_MODE</strong>
использовать последний режим)</li>
<li><p><strong>CITY_LIST_SEARCH_MODE</strong> <a id="search_mode" /> - 3 варианта поиска населенных пунктов в форме создания ТТН в DPD.</p>
<p><em>Используется чтобы избежать случайных ошибок в написании адреса.</em></p>
<ul>
<li><p><strong>0 - используя базу Dadata для выбора адреса вплоть до № квартиры (дефолтный выбор)</strong></p>
<p>(работает быстрее чем последних 2 варианта, с более умным поиском и сортировкой)</p>
</li>
<li><p><strong>1 - используя базу городов и регионов от Dadata</strong></p>
<p>(работает быстрее чем последних 2 варианта, с более умным поиском и сортировкой. Но в отличие от дефолтного -
улицу, дом, корпус и т.д. вводить самостоятельно)</p>
</li>
<li><p><strong>2 - используя выкачанную и проверенную базу городов и регионов от DPD</strong></p>
<p>(работает медленнее, неумная сортировка, зато уверенность, что в населенном пункте доступна доставка курьером.
Правда, последнее преимущество немного сомнительно - наверно не потребуется доставка из населенного пункта без
возможности обслуживания DPD курьером)</p>
</li>
<li><p><strong>3 - актуальную базу городов и регионов от DPD</strong></p>
<p>(те же особенности, как и прошлом пункте, но с обновленной базой - обновляют практически каждый день. Но нет
уверенности, что не изменятся условия предоставления этой базы населенных пунктов от DPD - может измениться
предоставляемое соединение к FTP от DPD, может значительно измениться расположение/имя файла, кодировка, новое
значение вдруг добавят. От того что добавят новую доступную автотрассу для доставки - вряд ли есть в этом польза
для работы. Хотя на момент написания режим 100% полностью имплементирован и работоспособен. Если выбран этот
режим, то хотя бы единоразово необходимо
выполнить <a href="#header_update_cities">Обновление списка городов от DPD</a>)</p>
</li>
</ul>
</li>
<li><strong>DADATA_API_KEY</strong> - Dadata персональный ключ. Необходим только если в <strong>CITY_LIST_SEARCH_MODE</strong> выбрать режим 0 (
дефолтный выбор)</li>
<li><strong>FTP_SERVER</strong>, <strong>FTP_USER</strong>, <strong>FTP_PASSWORD</strong> - необходимы только если в <strong>CITY_LIST_SEARCH_MODE</strong> выбран последний
режим)</li>
<li><strong>LOG_MIN_LEVEL</strong> - Минимальный порог для логирования. В файле (<strong>.env.example</strong>) перечислены варианты</li>
</ul>
<h3 id="-usedesk">Создание динамического блока внутри Usedesk</h3>
<ol>
<li>Авторизуемся в Usedesk</li>
<li>Переходим на <a href="https://secure.usedesk.ru/settings/blocks">страницу Блоки</a></li>
</ol>
<p><img src="http://gipernew.vertical-web.ru/dpd/docs/images/usedesk-blocks.png" alt="blocks"></p>
<ol>
<li>Убеждаемся, что среди списка предложенных уже нет созданного блока для доставки DPD</li>
<li>Нажимаем на кнопку &quot;Добавить динамический блок&quot;</li>
<li>Заполняем поля:<ul>
<li><strong>Имя</strong> - Произвольно выбираем.
Например: &quot;<code>DPD доставка</code>&quot;. Отображается лишь на странице Блоков (мы с этой страницы начинали установку)</li>
<li><strong>Заголовок</strong> - Произвольно выбираем.
Например: &quot;<code>DPD доставка</code>&quot;. Это поле будет отображаться в заголовке нашего создаваемого блока на странице каждого
тикета (заявки)</li>
<li><strong>Содержание блока</strong> - Оставляем пустым</li>
<li><strong>URL</strong> - <a id="usedesk_url" /> Путь к основному выполняемому файлу.
Например: <code>http://your.domain/usedesk-dpd.php</code> (можно без имени файла в конце, если
выполнен <a href="#index_file">пункт 5</a> при установке на сервер)</li>
<li><strong>Включен</strong> - ставим галочку, если хотим включить. Убираем, если отключить</li>
</ul>
</li>
</ol>
<h3 id="-usedesk">Включение и отключение блока внутри Usedesk</h3>
<ol>
<li>Авторизируемся в Usedesk</li>
<li>Переходим на <a href="https://secure.usedesk.ru/settings/blocks">страницу Блоки</a></li>
<li>Находим среди уже созданных блоков искомый (в названии скорее всего будет фигурировать <code>DPD</code>)</li>
<li>В поле <strong>Включен</strong> - ставим галочку, если хотим включить. Убираем, если отключить</li>
</ol>
<h2 id="-">Принцип работы</h2>
<p>Если не брать в расчет вспомогательный функционал и описать один распространенный сценарий использования:</p>
<ol>
<li>Пользователь переходит на страницу тикета в Usedesk</li>
<li>При открытии страницы тикета Usedesk отправляет на указанный в настройках динамического блока адрес POST запрос с
набором данных о тикете</li>
<li>Сервер берет из этого запроса ID тикета (тот же, что и у страницы тикета, на которую перешел пользователь в первом
пункте)</li>
<li>Сервер ищет в своей генерируемой базе создан ли уже ТТН для этого тикета (файл /data/bd.json)</li>
<li>Предположим, что для этого тикета ТТН не была создана. Сервер генерирует HTML-содержимое динамического блока
UseDesk. В данном случае - с кнопкой перехода на страницу оформления заказа</li>
<li>Пользователь в динамическом блоке справа видит, что ТТН в DPD не создана</li>
<li>Переходит, используя кнопку в блоке. И попадает на страницу оформления заказа</li>
<li>Заполняет поля и нажимает кнопку отправить</li>
<li>Сервер отправляет запрос в DPD, получает ответ. Если положительный или статус доработки - записывает в свою базу:
тикет Usedesk, присвоенный ТТН, внутренний номер заказа и статус. Если ошибка приходит от DPD - сообщает об этом
пользователю</li>
<li>Пользователь видит на экране надпись: &quot;Заказ успешно создан&quot;</li>
<li>После этого пользователь, совершивший оформление, или другой: возвращается в Usedesk на страницу тикета</li>
<li>На сервер опять поступает POST запрос, но на этот раз сервер находит тикет в своем списке, видит полученный статус и
номер ТТН</li>
<li>Прежде чем сгенерировать новое содержание блока в Usedesk: сервер отправляет запрос в DPD с номером ТТН
перепроверить статус</li>
<li>В динамическом блоке на странице тикета в Usedesk пользователь всегда увидит отображение актуальной информации о
статусе оформления ТТН от DPD.</li>
</ol>
</body></html>