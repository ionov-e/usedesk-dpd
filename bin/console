#!/usr/bin/env php
<?php

/** Сюда прилетает крон-задача и выполняется апдейт статусов выполнения заказов.
 * Служит, чтобы предотвратить возможную ситуацию хранения более 90 дней не последнего статуса выполнения заказа
 * без проверки с сервером DPD.
 * Объяснение: Ведь без этого исполняемого скрипта получение статуса выполнения заказа от DPD происходит только при
 * каждом переходе на страницу тикета\заявки в UseDesk. А срок хранения статуса на сервере DPD 90 дней. Т.е. если
 * пользователь задет на страницу тикета в UseDesk и получит не последний статус выполнения заказа. А в следующий раз
 * зайдет на страницу тикета, к примеру, через 120 дней - он увидит последний полученный статус из БД. Ведь от сервера
 * уже статус никакой не получит.
 */

use App\Service\DpdOrder;

$pathToRootFolder = realpath(dirname(__FILE__, 2));

require_once $pathToRootFolder . "/vendor/autoload.php";
require_once $pathToRootFolder . "/config/global.php";

if ($argc < 2) {
    echo "Укажите выполняемую команду. Для справки смотрите --help";
    echo PHP_EOL;
    exit(1);
}

if ($argv[1] == "--help") {
    echo "Список доступных скриптов:\n";
    echo "state/check\t\t-\tпроверка статусов всех заявок";
    echo PHP_EOL;
    exit(0);
}

switch ($argv[1]) {
    case "state/check":
        DpdOrder::updateProcessStates();
        break;
    default:
        echo "Неизвестная команда. Для справки смотрите --help";
        echo PHP_EOL;
}

exit(0);
